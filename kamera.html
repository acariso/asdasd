<!DOCTYPE html>
<html>
<head>
    <title>Dinleyen (Receiver)</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; background-color: #e6f7ff; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; cursor: pointer; background-color: #28a745; color: white; border: none; border-radius: 5px; }
        button:hover { background-color: #218838; }
        #status { margin-top: 20px; font-weight: bold; color: #333; }
    </style>
</head>
<body>
    <h1>Dinleyen (Receiver)</h1>
    <audio id="remoteAudio" autoplay playsinline></audio>
    <div>
        <button onclick="startReceivingAudio()">Yayını Dinle</button>
    </div>
    <div id="status">Durum: Bekliyor...</div>

    <script>
        const remoteAudio = document.getElementById('remoteAudio');
        const statusDiv = document.getElementById('status');
        let peerConnection;
        let signalingChannel;

        // BURAYI KENDİ SİNYAL SUNUCUSU URL'NİZLE DEĞİŞTİRİN
        const SIGNALING_SERVER_URL = "wss://ed66-2a00-1d36-283f-fe01-d0d6-34e9-2810-e5c9.ngrok-free.app";

        async function startReceivingAudio() {
            statusDiv.textContent = "Bağlantı bekleniyor...";

            signalingChannel = new WebSocket(SIGNALING_SERVER_URL);

            signalingChannel.onopen = () => {
                console.log('Sinyal sunucusuna bağlandı.');
                statusDiv.textContent = "Sinyal sunucusuna bağlandı. Ses yayını bekleniyor...";
                signalingChannel.send(JSON.stringify({ type: 'ready' }));
            };

            signalingChannel.onmessage = async (event) => {
                const message = JSON.parse(event.data);
                console.log('Gelen sinyal mesajı:', message.type);

                if (message.type === 'yourId') {
                    console.log('Kendi ID\'m:', message.id);
                } else if (message.type === 'offer') {
                    createPeerConnection();
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(message));
                    
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    signalingChannel.send(JSON.stringify({ type: 'answer', sdp: answer.sdp }));
                    statusDiv.textContent = "Teklif alındı, cevap gönderildi. ICE adayları bekleniyor...";

                } else if (message.type === 'candidate') {
                    try {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                        console.log('ICE adayı eklendi.');
                    } catch (e) {
                        console.error('ICE adayı eklenirken hata:', e);
                    }
                }
            };

            signalingChannel.onclose = () => {
                console.log('Sinyal sunucusu bağlantısı kesildi.');
                statusDiv.textContent = "Sinyal sunucusu bağlantısı kesildi.";
            };

            signalingChannel.onerror = (error) => {
                console.error('Sinyal sunucusu hatası:', error);
                statusDiv.textContent = "Sinyal sunucusu hatası.";
            };
        }

        function createPeerConnection() {
            const servers = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                ]
            };
            peerConnection = new RTCPeerConnection(servers);

            peerConnection.ontrack = (event) => {
                if (event.track.kind === 'audio' && remoteAudio.srcObject !== event.streams[0]) {
                    remoteAudio.srcObject = event.streams[0];
                    console.log('Uzak ses akışı alındı!');
                    statusDiv.textContent = "Ses akışı alınıyor!";
                }
            };

            peerConnection.onconnectionstatechange = () => {
                console.log('RTCPeerConnection durumu:', peerConnection.connectionState);
                if (peerConnection.connectionState === 'connected') {
                    statusDiv.textContent = "Bağlantı kuruldu! Ses yayını dinleniyor.";
                } else {
                     statusDiv.textContent = `Bağlantı durumu: ${peerConnection.connectionState}`;
                }
            };
        }
    </script>
</body>
</html>
