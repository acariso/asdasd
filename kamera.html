<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Küresel Mesajlaşma Sistemi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Genel Sıfırlama ve Temel Stiller */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #333;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            max-width: 800px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        h1 {
            font-size: 2.5em;
            color: #4a4a4a;
            margin-bottom: 10px;
            letter-spacing: -1px;
        }

        h2 {
            font-size: 1.8em;
            color: #555;
            margin-bottom: 25px;
        }
        
        p {
            font-size: 1.1em;
            color: #777;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .mode-selector {
            margin-bottom: 30px;
            background: #f0f0f0;
            border-radius: 50px;
            padding: 5px;
            display: inline-flex;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .mode-btn {
            background: none;
            color: #555;
            border: none;
            padding: 12px 25px;
            margin: 0;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: none;
        }
        
        .mode-btn:hover:not(.active) {
            background: rgba(0,0,0,0.05);
            color: #333;
        }
        
        .mode-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(-1px);
        }
        
        .section {
            display: none;
            animation: fadeIn 0.6s ease-in-out;
            padding-top: 20px;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .controls {
            margin: 25px 0;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 160px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .control-btn:disabled {
            background: #aab;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
        
        .status {
            margin: 20px auto;
            padding: 18px 25px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status.connected {
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
            border: 2px solid #4caf50;
        }
        
        .status.disconnected {
            background: rgba(244, 67, 54, 0.1);
            color: #c62828;
            border: 2px solid #f44336;
        }
        
        .status.connecting {
            background: rgba(255, 193, 7, 0.1);
            color: #f57c00;
            border: 2px solid #ffc107;
            animation: pulse 1.5s infinite;
        }

        .status.loading .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .room-info {
            background: rgba(103, 126, 234, 0.08);
            padding: 25px;
            border-radius: 18px;
            margin: 30px 0;
            border: 2px dashed #667eea;
            box-shadow: 0 8px 15px rgba(0,0,0,0.05);
        }
        
        .room-info h3 {
            color: #667eea;
            font-size: 1.6em;
            margin-bottom: 10px;
        }

        .room-code {
            font-size: 3.2em;
            font-weight: bold;
            color: #4455bb;
            letter-spacing: 5px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            display: inline-block;
            padding: 5px 15px;
            background: #e9eefd;
            border-radius: 10px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .room-info p {
            font-size: 0.95em;
            color: #666;
            margin-top: 10px;
        }
        
        .stats {
            background: rgba(0,0,0,0.03);
            padding: 20px;
            border-radius: 15px;
            margin: 25px 0;
            font-family: 'Consolas', monospace;
            font-size: 0.95em;
            text-align: left;
            line-height: 1.6;
            color: #444;
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* Custom Alert Modal Styles */
        #customAlertDialogOverlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #customAlertDialogOverlay.visible {
            opacity: 1;
        }

        #customAlertDialog {
            background: white;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: scale(0.7);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }

        #customAlertDialogOverlay.visible #customAlertDialog {
            transform: scale(1);
            opacity: 1;
        }

        #alertDialogTitle {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.6em;
        }

        #alertDialogMessage {
            margin-bottom: 30px;
            color: #666;
            font-size: 1.1em;
            line-height: 1.4;
            word-wrap: break-word; /* For long messages */
        }

        #alertDialogCloseBtn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.05em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        #alertDialogCloseBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        /* Yeni loading spinner CSS */
        .spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #667eea; /* Blue */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mesajlaşma UI Stilleri */
        .chat-area {
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            height: 300px; /* Sabit yükseklik */
            overflow-y: auto; /* Scrollable */
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        .chat-message {
            background: #e9eefd;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.95em;
            line-height: 1.4;
            color: #333;
        }

        .chat-message.self {
            align-self: flex-end;
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .chat-message.other {
            align-self: flex-start;
            background: #f0f0f0;
            color: #444;
            border-bottom-left-radius: 2px;
        }

        .chat-input-group {
            display: flex;
            margin-top: 20px;
            gap: 10px;
        }

        .chat-input-group input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .chat-input-group input:focus {
            border-color: #667eea;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.2);
        }

        .chat-input-group button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .chat-input-group button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .chat-input-group button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        .chat-meta {
            font-size: 0.75em;
            color: #888;
            margin-top: 5px;
            text-align: right;
        }
        .chat-message.other .chat-meta {
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌍 Küresel Mesajlaşma Sistemi</h1>
        <p style="margin: 15px 0; color: #666;">Aynı cihazda veya yerel ağınızdaki diğer cihazlarla mesajlaşın.</p>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('host')">💬 Sohbet Odası Oluştur</button>
            <button class="mode-btn" onclick="switchMode('client')">🤝 Sohbet Odasına Katıl</button>
        </div>
        
        <!-- Sohbet Odası Oluştur Bölümü (Host) -->
        <div id="host-section" class="section active">
            <h2>💬 Sohbet Odası (Host)</h2>
            
            <div class="controls">
                <button id="startChatHost" class="control-btn" disabled><i class="fas fa-comments"></i> Sohbeti Başlat</button>
                <button id="stopChatHost" class="control-btn" disabled><i class="fas fa-times"></i> Sohbeti Durdur</button>
            </div>
            
            <div id="hostStatus" class="status disconnected">
                <i class="fas fa-times-circle"></i> Sistem Bağlantısı Yok
            </div>
            
            <div id="roomDisplay" class="room-info">
                <h3>🔑 Sohbet Odası Adı</h3>
                <div id="roomCode" class="room-code">ODA1</div>
                <p>Diğer cihazların sohbetinize katılmak için bu sabit oda adını kullanması gerekir.</p>
                <p style="font-size: 0.9em; color: #888; margin-top: 15px;">
                    **İpuçları:** <br>
                    1. CMD ekranında PeerJS sunucusunun "Started PeerServer..." yazdığından emin olun. <br>
                    2. Bu sayfayı açtıktan sonra **"Sistem Bağlantısı Var"** mesajını bekleyin. <br>
                    3. Ardından "Sohbeti Başlat" butonuna tıklayın.
                </p>
            </div>
            
            <div class="chat-area" id="hostMessages">
                <!-- Mesajlar buraya eklenecek -->
            </div>

            <div class="chat-input-group">
                <input type="text" id="hostMessageInput" placeholder="Mesajınızı yazın..." disabled>
                <button id="hostSendMessageBtn" disabled><i class="fas fa-paper-plane"></i> Gönder</button>
            </div>

            <div id="hostStats" class="stats" style="display: none;"></div>
        </div>
        
        <!-- Sohbet Odasına Katıl Bölümü (Client) -->
        <div id="client-section" class="section">
            <h2>🤝 Sohbet Odasına Katıl (Client)</h2>
            
            <p style="margin: 15px 0; color: #666; font-size: 16px;">"ODA1" odasındaki sohbete katılmek için "Sohbete Katıl" butonuna tıklayın.</p>
            
            <div class="controls">
                <button id="joinChatClient" class="control-btn" disabled><i class="fas fa-handshake"></i> Sohbet Odasına Katıl</button>
                <button id="leaveChatClient" class="control-btn" disabled><i class="fas fa-sign-out-alt"></i> Sohbetten Ayrıl</button>
            </div>
            
            <div id="clientStatus" class="status disconnected">
                <i class="fas fa-times-circle"></i> Sistem Bağlantısı Yok
            </div>

            <div class="chat-area" id="clientMessages">
                <!-- Mesajlar buraya eklenecek -->
            </div>

            <div class="chat-input-group">
                <input type="text" id="clientMessageInput" placeholder="Mesajınızı yazın..." disabled>
                <button id="clientSendMessageBtn" disabled><i class="fas fa-paper-plane"></i> Gönder</button>
            </div>

            <p style="font-size: 0.9em; color: #888; margin-top: 15px;">
                **İpuçları:** <br>
                1. Sohbet Odası Oluşturucu (Host) aktif olduğundan ve "ODA1" sohbetini başlattığından emin olun. <br>
                2. Bu sayfayı açtıktan sonra **"Sistem Bağlantısı Var"** mesajını bekleyin. <br>
                3. Ardından "Sohbete Katıl" butonuna tıklayın.
            </p>
            
            <div id="clientStats" class="stats" style="display: none;"></div>
        </div>
    </div>

    <!-- Custom Alert Modal HTML -->
    <div id="customAlertDialogOverlay">
        <div id="customAlertDialog">
            <h3 id="alertDialogTitle"></h3>
            <p id="alertDialogMessage"></p>
            <button id="alertDialogCloseBtn">Tamam</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script>
        let peer = null;
        const DEFAULT_ROOM_ID = 'ODA1'; // Sabit sohbet odası adı
        let currentRoom = DEFAULT_ROOM_ID;
        let isHost = false; // Yayıncı yerine "Host" terimini kullanıyoruz
        let statsInterval = null;
        let isPeerOpen = false; // PeerJS sunucusuyla bağlantının açık olup olmadığını takip eder
        
        // Host (ODA1) birden fazla bağlantıyı yönetebilir
        let activeConnections = {}; // Bağlı istemcileri saklar {peerId: dataConnection}
        // Client sadece tek bir bağlantı (ODA1'e) kurar
        let hostConnection = null; // Client'ın host ile olan bağlantısı

        // Yeniden deneme ayarları (istemci bağlantısı için)
        let joinAttempts = 0;
        const MAX_JOIN_ATTEMPTS = 5;
        const JOIN_RETRY_DELAY = 2000; // 2 saniye

        // PeerJS istemcisini başlatma veya yeniden başlatma fonksiyonu
        async function initializePeer() {
            if (peer && peer.open) {
                console.log('Peer zaten başlatılmış ve aktif:', peer.id);
                isPeerOpen = true;
                updateButtonsAndInputs();
                return Promise.resolve(peer);
            }

            if (peer && !peer.destroyed) {
                peer.destroy();
                peer = null;
                isPeerOpen = false;
                updateButtonsAndInputs();
                console.log('Mevcut Peer objesi yeniden başlatma için temizlendi.');
            }

            updateStatus('connecting', '<span class="spinner"></span> Sisteme bağlanıyor...');

            return new Promise((resolve, reject) => {
                const peerId = isHost ? DEFAULT_ROOM_ID : undefined; 
                console.log(`Peer ID kullanılıyor: ${peerId || 'rastgele (istemci için)'}`);

                peer = new Peer(peerId, {
                    // DİKKAT: Eğer bu HTML dosyasını dışarıdan erişilebilir yapmak istiyorsanız,
                    // BURAYA KESİNLİKLE GENEL (PUBLIC) IP ADRESİNİZİ YAZMALISINIZ.
                    // Aksi takdirde sadece yerel ağınızdan çalışır.
                    // Genel IP adresiniz: 78.179.153.78
                    host: '192.168.1.108', 
                    port: 9000, 
                    secure: false,
                    path: '/myapp',
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });
                
                peer.on('open', function(id) {
                    console.log('Peer bağlantısı açıldı:', id);
                    isPeerOpen = true;
                    updateButtonsAndInputs();
                    if (isHost) {
                        currentRoom = id;
                        document.getElementById('roomCode').textContent = currentRoom;
                        document.getElementById('roomDisplay').style.display = 'block';
                        updateStatus('connected', '<i class="fas fa-check-circle"></i> Sistem hazır! Oda: ' + currentRoom);
                    } else {
                        updateStatus('connected', '<i class="fas fa-check-circle"></i> Sistem hazır! (ID: ' + id + ')');
                    }
                    resolve(peer);

                    // Host modunda gelen bağlantıları dinle
                    if (isHost) {
                        peer.on('connection', (conn) => {
                            console.log('Yeni bağlantı geldi:', conn.peer);
                            activeConnections[conn.peer] = conn; // Bağlantıyı sakla
                            displayMessage(`[${conn.peer}] katıldı.`, 'system');

                            conn.on('data', (data) => {
                                console.log(`[${conn.peer}]: ${data}`);
                                displayMessage(`[${conn.peer}]: ${data}`, 'other');
                                // Host olarak diğer bağlı istemcilere mesajı iletmek istiyorsanız buradan yapabilirsiniz
                                // for (let peerId in activeConnections) {
                                //     if (peerId !== conn.peer) {
                                //         activeConnections[peerId].send(`[${conn.peer}]: ${data}`);
                                //     }
                                // }
                            });

                            conn.on('close', () => {
                                console.log('Bağlantı kapatıldı:', conn.peer);
                                displayMessage(`[${conn.peer}] ayrıldı.`, 'system');
                                delete activeConnections[conn.peer];
                                updateButtonsAndInputs(); // Bağlantı sayısı değişebilir
                            });

                            conn.on('error', (err) => {
                                console.error('Bağlantı hatası:', conn.peer, err);
                                displayMessage(`[${conn.peer}] bağlantı hatası: ${err.type}`, 'system');
                                conn.close(); // Hatalı bağlantıyı kapat
                            });
                            updateButtonsAndInputs(); // Yeni bağlantı geldiğinde butonları güncelle
                        });
                    }
                });
                
                peer.on('disconnected', function() {
                    console.log('Peer bağlantısı kesildi.');
                    isPeerOpen = false;
                    updateStatus('disconnected', '<i class="fas fa-exclamation-triangle"></i> Sistem bağlantısı kesildi.');
                    updateButtonsAndInputs();
                    cleanupConnections(); // Tüm bağlantıları temizle
                });

                peer.on('close', function() {
                    console.log('Peer objesi kapandı.');
                    isPeerOpen = false;
                    updateStatus('disconnected', '<i class="fas fa-times-circle"></i> Sistem kapalı.');
                    updateButtonsAndInputs();
                    cleanupConnections(); // Tüm bağlantıları temizle
                });
                
                peer.on('error', function(err) {
                    console.error('Peer hatası:', err);
                    isPeerOpen = false;
                    // Hata mesajını daha detaylı göster
                    updateStatus('disconnected', '<i class="fas fa-exclamation-triangle"></i> Bağlantı hatası: ' + err.type + ' (' + err.message + ')'); 
                    updateButtonsAndInputs();

                    if (peer && !peer.destroyed) {
                        peer.destroy();
                        peer = null;
                    }
                    if (err.type === 'unavailable-id' && isHost) {
                        showAlert('Bu oda adı (' + DEFAULT_ROOM_ID + ') zaten kullanımda. Lütfen başka bir hostun sohbeti kapatmasını bekleyin veya daha sonra tekrar deneyin.', 'Oda Zaten Kullanımda');
                        updateStatus('disconnected', '<i class="fas fa-frown"></i> Oda dolu veya erişilemez.');
                    } else if (err.type === 'network') {
                         showAlert('PeerJS sunucusuna bağlanılamadı. Lütfen sunucunuzun aktif olduğundan (CMD\'de "Started PeerServer..." yazıyor mu?) ve modeminizde ' + peer.options.port + ' portu için port yönlendirme yapıldığından emin olun. Hata: ' + err.type + ' (' + err.message + ')', 'Bağlantı Hatası');
                    } else {
                         showAlert('Beklenmeyen bir PeerJS hatası oluştu: ' + err.type + ' (' + err.message + '). Lütfen konsolu kontrol edin.', 'Genel Hata');
                    }
                    reject(err);
                });
            });
        }

        // Buton ve input durumlarını güncelleyen yardımcı fonksiyon
        function updateButtonsAndInputs() {
            if (isHost) {
                document.getElementById('startChatHost').disabled = !(isPeerOpen && Object.keys(activeConnections).length === 0); // Peer açık ve henüz kimse bağlı değilse başlat aktif
                document.getElementById('stopChatHost').disabled = !isPeerOpen; // Peer açıksa durdur aktif
                document.getElementById('hostMessageInput').disabled = Object.keys(activeConnections).length === 0; // Bağlı istemci yoksa input disabled
                document.getElementById('hostSendMessageBtn').disabled = Object.keys(activeConnections).length === 0; // Bağlı istemci yoksa gönder disabled
            } else { // Client
                document.getElementById('joinChatClient').disabled = !(isPeerOpen && hostConnection === null); // Peer açık ve host'a bağlı değilse katıl aktif
                document.getElementById('leaveChatClient').disabled = (hostConnection === null); // Host'a bağlıysa ayrıl aktif
                document.getElementById('clientMessageInput').disabled = (hostConnection === null || !hostConnection.open); // Host'a bağlı değilse input disabled
                document.getElementById('clientSendMessageBtn').disabled = (hostConnection === null || !hostConnection.open); // Host'a bağlı değilse gönder disabled
            }
        }
        
        // Mod değiştirme
        function switchMode(mode) {
            cleanup(); // Mevcut bağlantıları ve akışları temizle
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            if (mode === 'host') {
                document.querySelector('.mode-btn[onclick="switchMode(\'host\')"]').classList.add('active');
                document.getElementById('host-section').classList.add('active');
                isHost = true;
                document.getElementById('roomCode').textContent = DEFAULT_ROOM_ID;
                document.getElementById('roomDisplay').style.display = 'block';
            } else { // client
                document.querySelector('.mode-btn[onclick="switchMode(\'client\')"]').classList.add('active');
                document.getElementById('client-section').classList.add('active');
                isHost = false;
                document.getElementById('roomDisplay').style.display = 'none';
            }
            
            updateStatus('connecting', '<span class="spinner"></span> Mod değiştirildi. Sistem hazırlanıyor...');
            initializePeer(); // Her mod değişiminde Peer'ı başlat/yeniden başlat
        }
        
        // Sohbet Hostu Başlatma
        async function startChatHost() {
            if (!peer || !peer.open) {
                await initializePeer();
            }

            if (!isPeerOpen) {
                showAlert('PeerJS bağlantısı henüz hazır değil. Lütfen "Sistem hazır!" mesajını bekleyin.', 'Hazırlık Hatası');
                return;
            }

            updateStatus('connected', '<i class="fas fa-check-circle"></i> Sohbet aktif! Bağlantı bekleniyor...');
            updateButtonsAndInputs();
            startStatsMonitoring();
            displayMessage('Sohbet odası başlatıldı. Bağlantı bekleniyor...', 'system');
        }
        
        // Sohbet Hostu Durdurma
        function stopChatHost() {
            cleanup();
            document.getElementById('roomDisplay').style.display = 'none';
            updateStatus('disconnected', '<i class="fas fa-times-circle"></i> Sohbet durduruldu.');
            initializePeer();
            updateButtonsAndInputs();
            document.getElementById('hostMessages').innerHTML = ''; // Mesajları temizle
        }
        
        // Sohbet Odasına Katılma (Client)
        async function joinChatClient() {
            if (!peer || !peer.open) {
                await initializePeer();
            }

            if (!isPeerOpen) {
                showAlert('PeerJS bağlantısı henüz hazır değil. Lütfen "Sistem hazır!" mesajını bekleyin.', 'Hazırlık Hatası');
                return;
            }
            
            try {
                updateStatus('connecting', '<span class="spinner"></span> Odaya bağlanıyor: ' + DEFAULT_ROOM_ID + ' (Deneme ' + (joinAttempts + 1) + '/' + MAX_JOIN_ATTEMPTS + ')');
                
                hostConnection = peer.connect(DEFAULT_ROOM_ID); // Host'a bağlan
                
                if (!hostConnection) {
                    console.error('Host bağlantı objesi oluşturulamadı. Tekrar denenecek.');
                    attemptJoinRoomRetry('Hosta bağlanılamadı. Tekrar deneniyor...');
                    return;
                }
                
                hostConnection.on('open', () => {
                    console.log('Host bağlantısı açıldı:', hostConnection.peer);
                    updateStatus('connected', '<i class="fas fa-comments"></i> Host\'a bağlandı! Mesaj gönderebilirsiniz.');
                    updateButtonsAndInputs();
                    startStatsMonitoring();
                    joinAttempts = 0;
                    displayMessage(`Host'a (${hostConnection.peer}) bağlandı.`, 'system');
                });

                hostConnection.on('data', (data) => {
                    console.log(`Host'tan gelen mesaj: ${data}`);
                    displayMessage(`[Host]: ${data}`, 'other');
                });

                hostConnection.on('close', () => {
                    console.log('Host bağlantısı kapatıldı.');
                    updateStatus('disconnected', '<i class="fas fa-volume-mute"></i> Sohbet sonlandı.');
                    hostConnection = null; // Bağlantıyı sıfırla
                    leaveChatClient(); // Temizlik ve UI güncelleme
                });
                
                hostConnection.on('error', (err) => {
                    console.error('Host bağlantı hatası:', err);
                    if (err.type === 'peer-unavailable' || err.type === 'network' || err.type === 'disconnected') {
                        attemptJoinRoomRetry('Bağlantı hatası: ' + err.type + ' (' + err.message + '). Tekrar deneniyor...');
                    } else {
                        updateStatus('disconnected', '<i class="fas fa-exclamation-circle"></i> Bağlantı hatası: ' + err.type + ' (' + err.message + ')');
                        showAlert('Hosta bağlanırken hata oluştu: ' + err.type + ' (' + err.message + '). Lütfen hostun aktifliğini kontrol edin.', 'Bağlantı Hatası');
                        leaveChatClient();
                    }
                });

            } catch (error) {
                console.error('Odaya katılma hatası:', error);
                attemptJoinRoomRetry('Odaya bağlanırken kritik hata oluştu: ' + error.message + '. Tekrar deneniyor...');
            }
        }

        // Yeniden deneme mekanizması
        function attemptJoinRoomRetry(message) {
            if (joinAttempts < MAX_JOIN_ATTEMPTS) {
                joinAttempts++;
                updateStatus('connecting', '<span class="spinner"></span> ' + message);
                console.log(`Tekrar deneniyor... (Deneme ${joinAttempts}/${MAX_JOIN_ATTEMPTS})`);
                setTimeout(() => {
                    if (hostConnection) {
                        hostConnection.close();
                        hostConnection = null;
                    }
                    joinChatClient();
                }, JOIN_RETRY_DELAY);
            } else {
                updateStatus('disconnected', '<i class="fas fa-frown"></i> Bağlantı kurulamadı. Lütfen hostun aktif olduğundan emin olun.');
                showAlert('Hosta bağlanılamadı. Lütfen hostun aktif olduğundan ve aynı ağda olduğunuzdan emin olun.', 'Bağlantı Başarısız');
                joinAttempts = 0;
                leaveChatClient();
            }
        }
        
        // Sohbetten Ayrılma (Client)
        function leaveChatClient() {
            if (hostConnection) {
                hostConnection.close();
                hostConnection = null;
            }
            updateStatus('disconnected', '<i class="fas fa-sign-out-alt"></i> Sohbetten ayrıldı.');
            stopStatsMonitoring();
            updateButtonsAndInputs();
            joinAttempts = 0;
            document.getElementById('clientMessages').innerHTML = ''; // Mesajları temizle
        }
        
        // Temizlik fonksiyonu
        function cleanup() {
            if (isHost) {
                for (let peerId in activeConnections) {
                    activeConnections[peerId].close();
                }
                activeConnections = {};
            } else { // Client
                if (hostConnection) {
                    hostConnection.close();
                    hostConnection = null;
                }
            }
            
            if (peer && !peer.destroyed) {
                peer.destroy();
                peer = null;
            }
            currentRoom = DEFAULT_ROOM_ID;
            stopStatsMonitoring();
            isPeerOpen = false;
            updateButtonsAndInputs();
            joinAttempts = 0;
        }
        
        // Mesaj gönderme fonksiyonu
        function sendMessage(isSenderHost) {
            let messageInputId = isSenderHost ? 'hostMessageInput' : 'clientMessageInput';
            let messageText = document.getElementById(messageInputId).value.trim();

            if (messageText === '') return;

            if (isSenderHost) {
                // Host olarak tüm bağlı istemcilere gönder
                if (Object.keys(activeConnections).length === 0) {
                    showAlert('Henüz bağlı bir istemci yok. Mesaj gönderilemedi.', 'Mesaj Gönderme Hatası');
                    return;
                }
                for (let peerId in activeConnections) {
                    activeConnections[peerId].send(messageText);
                }
                displayMessage(`[Sen]: ${messageText}`, 'self', isHost ? 'hostMessages' : 'clientMessages');
            } else {
                // Client olarak host'a gönder
                if (hostConnection && hostConnection.open) {
                    hostConnection.send(messageText);
                    displayMessage(`[Sen]: ${messageText}`, 'self', isHost ? 'hostMessages' : 'clientMessages');
                } else {
                    showAlert('Hosta bağlı değilsiniz. Mesaj gönderilemedi.', 'Mesaj Gönderme Hatası');
                    return;
                }
            }
            document.getElementById(messageInputId).value = ''; // Input'u temizle
        }

        // Mesajları görüntüleme fonksiyonu
        function displayMessage(message, type, targetChatAreaId = null) {
            let chatArea;
            if (targetChatAreaId) {
                chatArea = document.getElementById(targetChatAreaId);
            } else {
                chatArea = isHost ? document.getElementById('hostMessages') : document.getElementById('clientMessages');
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            messageDiv.classList.add(type);
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

            messageDiv.innerHTML = `<span>${message}</span><div class="chat-meta">${timeString}</div>`;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight; // En alta kaydır
        }


        // Durum güncelleme
        function updateStatus(status, message) {
            const hostStatus = document.getElementById('hostStatus');
            const clientStatus = document.getElementById('clientStatus');
            
            if (document.getElementById('host-section').classList.contains('active')) {
                if (hostStatus) {
                    hostStatus.className = 'status ' + status;
                    hostStatus.innerHTML = message; // innerHTML kullanıyoruz ki spinner iconu çalışsın
                }
            } else if (document.getElementById('client-section').classList.contains('active')) {
                if (clientStatus) {
                    clientStatus.className = 'status ' + status;
                    clientStatus.innerHTML = message; // innerHTML kullanıyoruz ki spinner iconu çalışsın
                }
            }
        }
        
        // İstatistik takibi
        function startStatsMonitoring() {
            if (statsInterval) return;
            
            statsInterval = setInterval(updateStats, 2000);
            document.querySelectorAll('.stats').forEach(el => el.style.display = 'block');
        }
        
        function stopStatsMonitoring() {
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            document.querySelectorAll('.stats').forEach(el => el.style.display = 'none');
        }
        
        function updateStats() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('tr-TR');
            
            let statsHtml = `
                🕐 Zaman: ${timeStr}<br>
                📊 Durum: ${peer && !peer.destroyed ? 'Bağlı' : 'Bağlantı Yok'}<br>
                🌐 Oda: ${currentRoom || 'Yok'}<br>
                📱 Cihaz: ${navigator.userAgent.includes('Mobile') ? 'Mobil' : 'Masaüstü'}<br>
                👥 Bağlı İstemci Sayısı: ${isHost ? Object.keys(activeConnections).length : (hostConnection && hostConnection.open ? 1 : 0)}
            `;
            
            if (document.getElementById('host-section').classList.contains('active')) {
                document.getElementById('hostStats').innerHTML = statsHtml;
            } else if (document.getElementById('client-section').classList.contains('active')) {
                document.getElementById('clientStats').innerHTML = statsHtml;
            }
        }
        
        // Özel Alert Modal fonksiyonu
        function showAlert(message, title = "Uyarı") {
            const overlay = document.getElementById('customAlertDialogOverlay');
            const dialogTitle = document.getElementById('alertDialogTitle');
            const dialogMessage = document.getElementById('alertDialogMessage');
            const closeBtn = document.getElementById('alertDialogCloseBtn');

            dialogTitle.textContent = title;
            dialogMessage.textContent = message;
            overlay.classList.add('visible');
            overlay.style.display = 'flex';

            const closeHandler = () => {
                overlay.classList.remove('visible');
                overlay.style.display = 'none';
                closeBtn.removeEventListener('click', closeHandler);
            };

            closeBtn.addEventListener('click', closeHandler);
        }

        // Event listeners
        document.getElementById('startChatHost').addEventListener('click', startChatHost);
        document.getElementById('stopChatHost').addEventListener('click', stopChatHost);
        document.getElementById('hostSendMessageBtn').addEventListener('click', () => sendMessage(true));
        document.getElementById('hostMessageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(true);
            }
        });

        document.getElementById('joinChatClient').addEventListener('click', joinChatClient);
        document.getElementById('leaveChatClient').addEventListener('click', leaveChatClient);
        document.getElementById('clientSendMessageBtn').addEventListener('click', () => sendMessage(false));
        document.getElementById('clientMessageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(false);
            }
        });
        
        // Sayfa yüklendiğinde
        window.addEventListener('load', function() {
            switchMode('host'); // Varsayılan olarak host modunda başla
        });
        
        // Sayfa kapatılırken kaynakları temizle
        window.addEventListener('beforeunload', function() {
            cleanup();
        });

        // Tüm bağlantıları temizleyen yardımcı fonksiyon (Peer kapatıldığında veya mod değiştirildiğinde)
        function cleanupConnections() {
            if (isHost) {
                for (let peerId in activeConnections) {
                    activeConnections[peerId].close();
                }
                activeConnections = {};
            } else { // Client
                if (hostConnection) {
                    hostConnection.close();
                    hostConnection = null;
                }
            }
        }
    </script>
</body>
</html>
