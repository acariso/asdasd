<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KÃ¼resel MesajlaÅŸma Sistemi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Genel SÄ±fÄ±rlama ve Temel Stiller */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #333;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            max-width: 800px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        h1 {
            font-size: 2.5em;
            color: #4a4a4a;
            margin-bottom: 10px;
            letter-spacing: -1px;
        }

        h2 {
            font-size: 1.8em;
            color: #555;
            margin-bottom: 25px;
        }
        
        p {
            font-size: 1.1em;
            color: #777;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .mode-selector {
            margin-bottom: 30px;
            background: #f0f0f0;
            border-radius: 50px;
            padding: 5px;
            display: inline-flex;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .mode-btn {
            background: none;
            color: #555;
            border: none;
            padding: 12px 25px;
            margin: 0;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: none;
        }
        
        .mode-btn:hover:not(.active) {
            background: rgba(0,0,0,0.05);
            color: #333;
        }
        
        .mode-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(-1px);
        }
        
        .section {
            display: none;
            animation: fadeIn 0.6s ease-in-out;
            padding-top: 20px;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .controls {
            margin: 25px 0;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 160px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .control-btn:disabled {
            background: #aab;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
        
        .status {
            margin: 20px auto;
            padding: 18px 25px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status.connected {
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
            border: 2px solid #4caf50;
        }
        
        .status.disconnected {
            background: rgba(244, 67, 54, 0.1);
            color: #c62828;
            border: 2px solid #f44336;
        }
        
        .status.connecting {
            background: rgba(255, 193, 7, 0.1);
            color: #f57c00;
            border: 2px solid #ffc107;
            animation: pulse 1.5s infinite;
        }

        .status.loading .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .room-info {
            background: rgba(103, 126, 234, 0.08);
            padding: 25px;
            border-radius: 18px;
            margin: 30px 0;
            border: 2px dashed #667eea;
            box-shadow: 0 8px 15px rgba(0,0,0,0.05);
        }
        
        .room-info h3 {
            color: #667eea;
            font-size: 1.6em;
            margin-bottom: 10px;
        }

        .room-code {
            font-size: 3.2em;
            font-weight: bold;
            color: #4455bb;
            letter-spacing: 5px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            display: inline-block;
            padding: 5px 15px;
            background: #e9eefd;
            border-radius: 10px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .room-info p {
            font-size: 0.95em;
            color: #666;
            margin-top: 10px;
        }
        
        .stats {
            background: rgba(0,0,0,0.03);
            padding: 20px;
            border-radius: 15px;
            margin: 25px 0;
            font-family: 'Consolas', monospace;
            font-size: 0.95em;
            text-align: left;
            line-height: 1.6;
            color: #444;
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* Custom Alert Modal Styles */
        #customAlertDialogOverlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #customAlertDialogOverlay.visible {
            opacity: 1;
        }

        #customAlertDialog {
            background: white;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: scale(0.7);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }

        #customAlertDialogOverlay.visible #customAlertDialog {
            transform: scale(1);
            opacity: 1;
        }

        #alertDialogTitle {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.6em;
        }

        #alertDialogMessage {
            margin-bottom: 30px;
            color: #666;
            font-size: 1.1em;
            line-height: 1.4;
            word-wrap: break-word; /* For long messages */
        }

        #alertDialogCloseBtn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.05em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        #alertDialogCloseBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        /* Yeni loading spinner CSS */
        .spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #667eea; /* Blue */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* MesajlaÅŸma UI Stilleri */
        .chat-area {
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            height: 300px; /* Sabit yÃ¼kseklik */
            overflow-y: auto; /* Scrollable */
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        .chat-message {
            background: #e9eefd;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.95em;
            line-height: 1.4;
            color: #333;
        }

        .chat-message.self {
            align-self: flex-end;
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .chat-message.other {
            align-self: flex-start;
            background: #f0f0f0;
            color: #444;
            border-bottom-left-radius: 2px;
        }

        .chat-input-group {
            display: flex;
            margin-top: 20px;
            gap: 10px;
        }

        .chat-input-group input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .chat-input-group input:focus {
            border-color: #667eea;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.2);
        }

        .chat-input-group button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .chat-input-group button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .chat-input-group button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        .chat-meta {
            font-size: 0.75em;
            color: #888;
            margin-top: 5px;
            text-align: right;
        }
        .chat-message.other .chat-meta {
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ KÃ¼resel MesajlaÅŸma Sistemi</h1>
        <p style="margin: 15px 0; color: #666;">AynÄ± cihazda veya yerel aÄŸÄ±nÄ±zdaki diÄŸer cihazlarla mesajlaÅŸÄ±n.</p>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('host')">ğŸ’¬ Sohbet OdasÄ± OluÅŸtur</button>
            <button class="mode-btn" onclick="switchMode('client')">ğŸ¤ Sohbet OdasÄ±na KatÄ±l</button>
        </div>
        
        <!-- Sohbet OdasÄ± OluÅŸtur BÃ¶lÃ¼mÃ¼ (Host) -->
        <div id="host-section" class="section active">
            <h2>ğŸ’¬ Sohbet OdasÄ± (Host)</h2>
            
            <div class="controls">
                <button id="startChatHost" class="control-btn" disabled><i class="fas fa-comments"></i> Sohbeti BaÅŸlat</button>
                <button id="stopChatHost" class="control-btn" disabled><i class="fas fa-times"></i> Sohbeti Durdur</button>
            </div>
            
            <div id="hostStatus" class="status disconnected">
                <i class="fas fa-times-circle"></i> Sistem BaÄŸlantÄ±sÄ± Yok
            </div>
            
            <div id="roomDisplay" class="room-info">
                <h3>ğŸ”‘ Sohbet OdasÄ± AdÄ±</h3>
                <div id="roomCode" class="room-code">ODA1</div>
                <p>DiÄŸer cihazlarÄ±n sohbetinize katÄ±lmak iÃ§in bu sabit oda adÄ±nÄ± kullanmasÄ± gerekir.</p>
                <p style="font-size: 0.9em; color: #888; margin-top: 15px;">
                    **Ä°puÃ§larÄ±:** <br>
                    1. CMD ekranÄ±nda PeerJS sunucusunun "Started PeerServer..." yazdÄ±ÄŸÄ±ndan emin olun. <br>
                    2. Bu sayfayÄ± aÃ§tÄ±ktan sonra **"Sistem BaÄŸlantÄ±sÄ± Var"** mesajÄ±nÄ± bekleyin. <br>
                    3. ArdÄ±ndan "Sohbeti BaÅŸlat" butonuna tÄ±klayÄ±n.
                </p>
            </div>
            
            <div class="chat-area" id="hostMessages">
                <!-- Mesajlar buraya eklenecek -->
            </div>

            <div class="chat-input-group">
                <input type="text" id="hostMessageInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." disabled>
                <button id="hostSendMessageBtn" disabled><i class="fas fa-paper-plane"></i> GÃ¶nder</button>
            </div>

            <div id="hostStats" class="stats" style="display: none;"></div>
        </div>
        
        <!-- Sohbet OdasÄ±na KatÄ±l BÃ¶lÃ¼mÃ¼ (Client) -->
        <div id="client-section" class="section">
            <h2>ğŸ¤ Sohbet OdasÄ±na KatÄ±l (Client)</h2>
            
            <p style="margin: 15px 0; color: #666; font-size: 16px;">"ODA1" odasÄ±ndaki sohbete katÄ±lmek iÃ§in "Sohbete KatÄ±l" butonuna tÄ±klayÄ±n.</p>
            
            <div class="controls">
                <button id="joinChatClient" class="control-btn" disabled><i class="fas fa-handshake"></i> Sohbet OdasÄ±na KatÄ±l</button>
                <button id="leaveChatClient" class="control-btn" disabled><i class="fas fa-sign-out-alt"></i> Sohbetten AyrÄ±l</button>
            </div>
            
            <div id="clientStatus" class="status disconnected">
                <i class="fas fa-times-circle"></i> Sistem BaÄŸlantÄ±sÄ± Yok
            </div>

            <div class="chat-area" id="clientMessages">
                <!-- Mesajlar buraya eklenecek -->
            </div>

            <div class="chat-input-group">
                <input type="text" id="clientMessageInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." disabled>
                <button id="clientSendMessageBtn" disabled><i class="fas fa-paper-plane"></i> GÃ¶nder</button>
            </div>

            <p style="font-size: 0.9em; color: #888; margin-top: 15px;">
                **Ä°puÃ§larÄ±:** <br>
                1. Sohbet OdasÄ± OluÅŸturucu (Host) aktif olduÄŸundan ve "ODA1" sohbetini baÅŸlattÄ±ÄŸÄ±ndan emin olun. <br>
                2. Bu sayfayÄ± aÃ§tÄ±ktan sonra **"Sistem BaÄŸlantÄ±sÄ± Var"** mesajÄ±nÄ± bekleyin. <br>
                3. ArdÄ±ndan "Sohbete KatÄ±l" butonuna tÄ±klayÄ±n.
            </p>
            
            <div id="clientStats" class="stats" style="display: none;"></div>
        </div>
    </div>

    <!-- Custom Alert Modal HTML -->
    <div id="customAlertDialogOverlay">
        <div id="customAlertDialog">
            <h3 id="alertDialogTitle"></h3>
            <p id="alertDialogMessage"></p>
            <button id="alertDialogCloseBtn">Tamam</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script>
        let peer = null;
        const DEFAULT_ROOM_ID = 'ODA1'; // Sabit sohbet odasÄ± adÄ±
        let currentRoom = DEFAULT_ROOM_ID;
        let isHost = false; // YayÄ±ncÄ± yerine "Host" terimini kullanÄ±yoruz
        let statsInterval = null;
        let isPeerOpen = false; // PeerJS sunucusuyla baÄŸlantÄ±nÄ±n aÃ§Ä±k olup olmadÄ±ÄŸÄ±nÄ± takip eder
        
        // Host (ODA1) birden fazla baÄŸlantÄ±yÄ± yÃ¶netebilir
        let activeConnections = {}; // BaÄŸlÄ± istemcileri saklar {peerId: dataConnection}
        // Client sadece tek bir baÄŸlantÄ± (ODA1'e) kurar
        let hostConnection = null; // Client'Ä±n host ile olan baÄŸlantÄ±sÄ±

        // Yeniden deneme ayarlarÄ± (istemci baÄŸlantÄ±sÄ± iÃ§in)
        let joinAttempts = 0;
        const MAX_JOIN_ATTEMPTS = 5;
        const JOIN_RETRY_DELAY = 2000; // 2 saniye

        // PeerJS istemcisini baÅŸlatma veya yeniden baÅŸlatma fonksiyonu
        async function initializePeer() {
            if (peer && peer.open) {
                console.log('Peer zaten baÅŸlatÄ±lmÄ±ÅŸ ve aktif:', peer.id);
                isPeerOpen = true;
                updateButtonsAndInputs();
                return Promise.resolve(peer);
            }

            if (peer && !peer.destroyed) {
                peer.destroy();
                peer = null;
                isPeerOpen = false;
                updateButtonsAndInputs();
                console.log('Mevcut Peer objesi yeniden baÅŸlatma iÃ§in temizlendi.');
            }

            updateStatus('connecting', '<span class="spinner"></span> Sisteme baÄŸlanÄ±yor...');

            return new Promise((resolve, reject) => {
                const peerId = isHost ? DEFAULT_ROOM_ID : undefined; 
                console.log(`Peer ID kullanÄ±lÄ±yor: ${peerId || 'rastgele (istemci iÃ§in)'}`);

                peer = new Peer(peerId, {
                    // DÄ°KKAT: EÄŸer bu HTML dosyasÄ±nÄ± dÄ±ÅŸarÄ±dan eriÅŸilebilir yapmak istiyorsanÄ±z,
                    // BURAYA KESÄ°NLÄ°KLE GENEL (PUBLIC) IP ADRESÄ°NÄ°ZÄ° YAZMALISINIZ.
                    // Aksi takdirde sadece yerel aÄŸÄ±nÄ±zdan Ã§alÄ±ÅŸÄ±r.
                    // Genel IP adresiniz: 78.179.153.78
                    host: '192.168.1.108', 
                    port: 9000, 
                    secure: false,
                    path: '/myapp',
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });
                
                peer.on('open', function(id) {
                    console.log('Peer baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±:', id);
                    isPeerOpen = true;
                    updateButtonsAndInputs();
                    if (isHost) {
                        currentRoom = id;
                        document.getElementById('roomCode').textContent = currentRoom;
                        document.getElementById('roomDisplay').style.display = 'block';
                        updateStatus('connected', '<i class="fas fa-check-circle"></i> Sistem hazÄ±r! Oda: ' + currentRoom);
                    } else {
                        updateStatus('connected', '<i class="fas fa-check-circle"></i> Sistem hazÄ±r! (ID: ' + id + ')');
                    }
                    resolve(peer);

                    // Host modunda gelen baÄŸlantÄ±larÄ± dinle
                    if (isHost) {
                        peer.on('connection', (conn) => {
                            console.log('Yeni baÄŸlantÄ± geldi:', conn.peer);
                            activeConnections[conn.peer] = conn; // BaÄŸlantÄ±yÄ± sakla
                            displayMessage(`[${conn.peer}] katÄ±ldÄ±.`, 'system');

                            conn.on('data', (data) => {
                                console.log(`[${conn.peer}]: ${data}`);
                                displayMessage(`[${conn.peer}]: ${data}`, 'other');
                                // Host olarak diÄŸer baÄŸlÄ± istemcilere mesajÄ± iletmek istiyorsanÄ±z buradan yapabilirsiniz
                                // for (let peerId in activeConnections) {
                                //     if (peerId !== conn.peer) {
                                //         activeConnections[peerId].send(`[${conn.peer}]: ${data}`);
                                //     }
                                // }
                            });

                            conn.on('close', () => {
                                console.log('BaÄŸlantÄ± kapatÄ±ldÄ±:', conn.peer);
                                displayMessage(`[${conn.peer}] ayrÄ±ldÄ±.`, 'system');
                                delete activeConnections[conn.peer];
                                updateButtonsAndInputs(); // BaÄŸlantÄ± sayÄ±sÄ± deÄŸiÅŸebilir
                            });

                            conn.on('error', (err) => {
                                console.error('BaÄŸlantÄ± hatasÄ±:', conn.peer, err);
                                displayMessage(`[${conn.peer}] baÄŸlantÄ± hatasÄ±: ${err.type}`, 'system');
                                conn.close(); // HatalÄ± baÄŸlantÄ±yÄ± kapat
                            });
                            updateButtonsAndInputs(); // Yeni baÄŸlantÄ± geldiÄŸinde butonlarÄ± gÃ¼ncelle
                        });
                    }
                });
                
                peer.on('disconnected', function() {
                    console.log('Peer baÄŸlantÄ±sÄ± kesildi.');
                    isPeerOpen = false;
                    updateStatus('disconnected', '<i class="fas fa-exclamation-triangle"></i> Sistem baÄŸlantÄ±sÄ± kesildi.');
                    updateButtonsAndInputs();
                    cleanupConnections(); // TÃ¼m baÄŸlantÄ±larÄ± temizle
                });

                peer.on('close', function() {
                    console.log('Peer objesi kapandÄ±.');
                    isPeerOpen = false;
                    updateStatus('disconnected', '<i class="fas fa-times-circle"></i> Sistem kapalÄ±.');
                    updateButtonsAndInputs();
                    cleanupConnections(); // TÃ¼m baÄŸlantÄ±larÄ± temizle
                });
                
                peer.on('error', function(err) {
                    console.error('Peer hatasÄ±:', err);
                    isPeerOpen = false;
                    // Hata mesajÄ±nÄ± daha detaylÄ± gÃ¶ster
                    updateStatus('disconnected', '<i class="fas fa-exclamation-triangle"></i> BaÄŸlantÄ± hatasÄ±: ' + err.type + ' (' + err.message + ')'); 
                    updateButtonsAndInputs();

                    if (peer && !peer.destroyed) {
                        peer.destroy();
                        peer = null;
                    }
                    if (err.type === 'unavailable-id' && isHost) {
                        showAlert('Bu oda adÄ± (' + DEFAULT_ROOM_ID + ') zaten kullanÄ±mda. LÃ¼tfen baÅŸka bir hostun sohbeti kapatmasÄ±nÄ± bekleyin veya daha sonra tekrar deneyin.', 'Oda Zaten KullanÄ±mda');
                        updateStatus('disconnected', '<i class="fas fa-frown"></i> Oda dolu veya eriÅŸilemez.');
                    } else if (err.type === 'network') {
                         showAlert('PeerJS sunucusuna baÄŸlanÄ±lamadÄ±. LÃ¼tfen sunucunuzun aktif olduÄŸundan (CMD\'de "Started PeerServer..." yazÄ±yor mu?) ve modeminizde ' + peer.options.port + ' portu iÃ§in port yÃ¶nlendirme yapÄ±ldÄ±ÄŸÄ±ndan emin olun. Hata: ' + err.type + ' (' + err.message + ')', 'BaÄŸlantÄ± HatasÄ±');
                    } else {
                         showAlert('Beklenmeyen bir PeerJS hatasÄ± oluÅŸtu: ' + err.type + ' (' + err.message + '). LÃ¼tfen konsolu kontrol edin.', 'Genel Hata');
                    }
                    reject(err);
                });
            });
        }

        // Buton ve input durumlarÄ±nÄ± gÃ¼ncelleyen yardÄ±mcÄ± fonksiyon
        function updateButtonsAndInputs() {
            if (isHost) {
                document.getElementById('startChatHost').disabled = !(isPeerOpen && Object.keys(activeConnections).length === 0); // Peer aÃ§Ä±k ve henÃ¼z kimse baÄŸlÄ± deÄŸilse baÅŸlat aktif
                document.getElementById('stopChatHost').disabled = !isPeerOpen; // Peer aÃ§Ä±ksa durdur aktif
                document.getElementById('hostMessageInput').disabled = Object.keys(activeConnections).length === 0; // BaÄŸlÄ± istemci yoksa input disabled
                document.getElementById('hostSendMessageBtn').disabled = Object.keys(activeConnections).length === 0; // BaÄŸlÄ± istemci yoksa gÃ¶nder disabled
            } else { // Client
                document.getElementById('joinChatClient').disabled = !(isPeerOpen && hostConnection === null); // Peer aÃ§Ä±k ve host'a baÄŸlÄ± deÄŸilse katÄ±l aktif
                document.getElementById('leaveChatClient').disabled = (hostConnection === null); // Host'a baÄŸlÄ±ysa ayrÄ±l aktif
                document.getElementById('clientMessageInput').disabled = (hostConnection === null || !hostConnection.open); // Host'a baÄŸlÄ± deÄŸilse input disabled
                document.getElementById('clientSendMessageBtn').disabled = (hostConnection === null || !hostConnection.open); // Host'a baÄŸlÄ± deÄŸilse gÃ¶nder disabled
            }
        }
        
        // Mod deÄŸiÅŸtirme
        function switchMode(mode) {
            cleanup(); // Mevcut baÄŸlantÄ±larÄ± ve akÄ±ÅŸlarÄ± temizle
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            if (mode === 'host') {
                document.querySelector('.mode-btn[onclick="switchMode(\'host\')"]').classList.add('active');
                document.getElementById('host-section').classList.add('active');
                isHost = true;
                document.getElementById('roomCode').textContent = DEFAULT_ROOM_ID;
                document.getElementById('roomDisplay').style.display = 'block';
            } else { // client
                document.querySelector('.mode-btn[onclick="switchMode(\'client\')"]').classList.add('active');
                document.getElementById('client-section').classList.add('active');
                isHost = false;
                document.getElementById('roomDisplay').style.display = 'none';
            }
            
            updateStatus('connecting', '<span class="spinner"></span> Mod deÄŸiÅŸtirildi. Sistem hazÄ±rlanÄ±yor...');
            initializePeer(); // Her mod deÄŸiÅŸiminde Peer'Ä± baÅŸlat/yeniden baÅŸlat
        }
        
        // Sohbet Hostu BaÅŸlatma
        async function startChatHost() {
            if (!peer || !peer.open) {
                await initializePeer();
            }

            if (!isPeerOpen) {
                showAlert('PeerJS baÄŸlantÄ±sÄ± henÃ¼z hazÄ±r deÄŸil. LÃ¼tfen "Sistem hazÄ±r!" mesajÄ±nÄ± bekleyin.', 'HazÄ±rlÄ±k HatasÄ±');
                return;
            }

            updateStatus('connected', '<i class="fas fa-check-circle"></i> Sohbet aktif! BaÄŸlantÄ± bekleniyor...');
            updateButtonsAndInputs();
            startStatsMonitoring();
            displayMessage('Sohbet odasÄ± baÅŸlatÄ±ldÄ±. BaÄŸlantÄ± bekleniyor...', 'system');
        }
        
        // Sohbet Hostu Durdurma
        function stopChatHost() {
            cleanup();
            document.getElementById('roomDisplay').style.display = 'none';
            updateStatus('disconnected', '<i class="fas fa-times-circle"></i> Sohbet durduruldu.');
            initializePeer();
            updateButtonsAndInputs();
            document.getElementById('hostMessages').innerHTML = ''; // MesajlarÄ± temizle
        }
        
        // Sohbet OdasÄ±na KatÄ±lma (Client)
        async function joinChatClient() {
            if (!peer || !peer.open) {
                await initializePeer();
            }

            if (!isPeerOpen) {
                showAlert('PeerJS baÄŸlantÄ±sÄ± henÃ¼z hazÄ±r deÄŸil. LÃ¼tfen "Sistem hazÄ±r!" mesajÄ±nÄ± bekleyin.', 'HazÄ±rlÄ±k HatasÄ±');
                return;
            }
            
            try {
                updateStatus('connecting', '<span class="spinner"></span> Odaya baÄŸlanÄ±yor: ' + DEFAULT_ROOM_ID + ' (Deneme ' + (joinAttempts + 1) + '/' + MAX_JOIN_ATTEMPTS + ')');
                
                hostConnection = peer.connect(DEFAULT_ROOM_ID); // Host'a baÄŸlan
                
                if (!hostConnection) {
                    console.error('Host baÄŸlantÄ± objesi oluÅŸturulamadÄ±. Tekrar denenecek.');
                    attemptJoinRoomRetry('Hosta baÄŸlanÄ±lamadÄ±. Tekrar deneniyor...');
                    return;
                }
                
                hostConnection.on('open', () => {
                    console.log('Host baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±:', hostConnection.peer);
                    updateStatus('connected', '<i class="fas fa-comments"></i> Host\'a baÄŸlandÄ±! Mesaj gÃ¶nderebilirsiniz.');
                    updateButtonsAndInputs();
                    startStatsMonitoring();
                    joinAttempts = 0;
                    displayMessage(`Host'a (${hostConnection.peer}) baÄŸlandÄ±.`, 'system');
                });

                hostConnection.on('data', (data) => {
                    console.log(`Host'tan gelen mesaj: ${data}`);
                    displayMessage(`[Host]: ${data}`, 'other');
                });

                hostConnection.on('close', () => {
                    console.log('Host baÄŸlantÄ±sÄ± kapatÄ±ldÄ±.');
                    updateStatus('disconnected', '<i class="fas fa-volume-mute"></i> Sohbet sonlandÄ±.');
                    hostConnection = null; // BaÄŸlantÄ±yÄ± sÄ±fÄ±rla
                    leaveChatClient(); // Temizlik ve UI gÃ¼ncelleme
                });
                
                hostConnection.on('error', (err) => {
                    console.error('Host baÄŸlantÄ± hatasÄ±:', err);
                    if (err.type === 'peer-unavailable' || err.type === 'network' || err.type === 'disconnected') {
                        attemptJoinRoomRetry('BaÄŸlantÄ± hatasÄ±: ' + err.type + ' (' + err.message + '). Tekrar deneniyor...');
                    } else {
                        updateStatus('disconnected', '<i class="fas fa-exclamation-circle"></i> BaÄŸlantÄ± hatasÄ±: ' + err.type + ' (' + err.message + ')');
                        showAlert('Hosta baÄŸlanÄ±rken hata oluÅŸtu: ' + err.type + ' (' + err.message + '). LÃ¼tfen hostun aktifliÄŸini kontrol edin.', 'BaÄŸlantÄ± HatasÄ±');
                        leaveChatClient();
                    }
                });

            } catch (error) {
                console.error('Odaya katÄ±lma hatasÄ±:', error);
                attemptJoinRoomRetry('Odaya baÄŸlanÄ±rken kritik hata oluÅŸtu: ' + error.message + '. Tekrar deneniyor...');
            }
        }

        // Yeniden deneme mekanizmasÄ±
        function attemptJoinRoomRetry(message) {
            if (joinAttempts < MAX_JOIN_ATTEMPTS) {
                joinAttempts++;
                updateStatus('connecting', '<span class="spinner"></span> ' + message);
                console.log(`Tekrar deneniyor... (Deneme ${joinAttempts}/${MAX_JOIN_ATTEMPTS})`);
                setTimeout(() => {
                    if (hostConnection) {
                        hostConnection.close();
                        hostConnection = null;
                    }
                    joinChatClient();
                }, JOIN_RETRY_DELAY);
            } else {
                updateStatus('disconnected', '<i class="fas fa-frown"></i> BaÄŸlantÄ± kurulamadÄ±. LÃ¼tfen hostun aktif olduÄŸundan emin olun.');
                showAlert('Hosta baÄŸlanÄ±lamadÄ±. LÃ¼tfen hostun aktif olduÄŸundan ve aynÄ± aÄŸda olduÄŸunuzdan emin olun.', 'BaÄŸlantÄ± BaÅŸarÄ±sÄ±z');
                joinAttempts = 0;
                leaveChatClient();
            }
        }
        
        // Sohbetten AyrÄ±lma (Client)
        function leaveChatClient() {
            if (hostConnection) {
                hostConnection.close();
                hostConnection = null;
            }
            updateStatus('disconnected', '<i class="fas fa-sign-out-alt"></i> Sohbetten ayrÄ±ldÄ±.');
            stopStatsMonitoring();
            updateButtonsAndInputs();
            joinAttempts = 0;
            document.getElementById('clientMessages').innerHTML = ''; // MesajlarÄ± temizle
        }
        
        // Temizlik fonksiyonu
        function cleanup() {
            if (isHost) {
                for (let peerId in activeConnections) {
                    activeConnections[peerId].close();
                }
                activeConnections = {};
            } else { // Client
                if (hostConnection) {
                    hostConnection.close();
                    hostConnection = null;
                }
            }
            
            if (peer && !peer.destroyed) {
                peer.destroy();
                peer = null;
            }
            currentRoom = DEFAULT_ROOM_ID;
            stopStatsMonitoring();
            isPeerOpen = false;
            updateButtonsAndInputs();
            joinAttempts = 0;
        }
        
        // Mesaj gÃ¶nderme fonksiyonu
        function sendMessage(isSenderHost) {
            let messageInputId = isSenderHost ? 'hostMessageInput' : 'clientMessageInput';
            let messageText = document.getElementById(messageInputId).value.trim();

            if (messageText === '') return;

            if (isSenderHost) {
                // Host olarak tÃ¼m baÄŸlÄ± istemcilere gÃ¶nder
                if (Object.keys(activeConnections).length === 0) {
                    showAlert('HenÃ¼z baÄŸlÄ± bir istemci yok. Mesaj gÃ¶nderilemedi.', 'Mesaj GÃ¶nderme HatasÄ±');
                    return;
                }
                for (let peerId in activeConnections) {
                    activeConnections[peerId].send(messageText);
                }
                displayMessage(`[Sen]: ${messageText}`, 'self', isHost ? 'hostMessages' : 'clientMessages');
            } else {
                // Client olarak host'a gÃ¶nder
                if (hostConnection && hostConnection.open) {
                    hostConnection.send(messageText);
                    displayMessage(`[Sen]: ${messageText}`, 'self', isHost ? 'hostMessages' : 'clientMessages');
                } else {
                    showAlert('Hosta baÄŸlÄ± deÄŸilsiniz. Mesaj gÃ¶nderilemedi.', 'Mesaj GÃ¶nderme HatasÄ±');
                    return;
                }
            }
            document.getElementById(messageInputId).value = ''; // Input'u temizle
        }

        // MesajlarÄ± gÃ¶rÃ¼ntÃ¼leme fonksiyonu
        function displayMessage(message, type, targetChatAreaId = null) {
            let chatArea;
            if (targetChatAreaId) {
                chatArea = document.getElementById(targetChatAreaId);
            } else {
                chatArea = isHost ? document.getElementById('hostMessages') : document.getElementById('clientMessages');
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            messageDiv.classList.add(type);
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

            messageDiv.innerHTML = `<span>${message}</span><div class="chat-meta">${timeString}</div>`;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight; // En alta kaydÄ±r
        }


        // Durum gÃ¼ncelleme
        function updateStatus(status, message) {
            const hostStatus = document.getElementById('hostStatus');
            const clientStatus = document.getElementById('clientStatus');
            
            if (document.getElementById('host-section').classList.contains('active')) {
                if (hostStatus) {
                    hostStatus.className = 'status ' + status;
                    hostStatus.innerHTML = message; // innerHTML kullanÄ±yoruz ki spinner iconu Ã§alÄ±ÅŸsÄ±n
                }
            } else if (document.getElementById('client-section').classList.contains('active')) {
                if (clientStatus) {
                    clientStatus.className = 'status ' + status;
                    clientStatus.innerHTML = message; // innerHTML kullanÄ±yoruz ki spinner iconu Ã§alÄ±ÅŸsÄ±n
                }
            }
        }
        
        // Ä°statistik takibi
        function startStatsMonitoring() {
            if (statsInterval) return;
            
            statsInterval = setInterval(updateStats, 2000);
            document.querySelectorAll('.stats').forEach(el => el.style.display = 'block');
        }
        
        function stopStatsMonitoring() {
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            document.querySelectorAll('.stats').forEach(el => el.style.display = 'none');
        }
        
        function updateStats() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('tr-TR');
            
            let statsHtml = `
                ğŸ• Zaman: ${timeStr}<br>
                ğŸ“Š Durum: ${peer && !peer.destroyed ? 'BaÄŸlÄ±' : 'BaÄŸlantÄ± Yok'}<br>
                ğŸŒ Oda: ${currentRoom || 'Yok'}<br>
                ğŸ“± Cihaz: ${navigator.userAgent.includes('Mobile') ? 'Mobil' : 'MasaÃ¼stÃ¼'}<br>
                ğŸ‘¥ BaÄŸlÄ± Ä°stemci SayÄ±sÄ±: ${isHost ? Object.keys(activeConnections).length : (hostConnection && hostConnection.open ? 1 : 0)}
            `;
            
            if (document.getElementById('host-section').classList.contains('active')) {
                document.getElementById('hostStats').innerHTML = statsHtml;
            } else if (document.getElementById('client-section').classList.contains('active')) {
                document.getElementById('clientStats').innerHTML = statsHtml;
            }
        }
        
        // Ã–zel Alert Modal fonksiyonu
        function showAlert(message, title = "UyarÄ±") {
            const overlay = document.getElementById('customAlertDialogOverlay');
            const dialogTitle = document.getElementById('alertDialogTitle');
            const dialogMessage = document.getElementById('alertDialogMessage');
            const closeBtn = document.getElementById('alertDialogCloseBtn');

            dialogTitle.textContent = title;
            dialogMessage.textContent = message;
            overlay.classList.add('visible');
            overlay.style.display = 'flex';

            const closeHandler = () => {
                overlay.classList.remove('visible');
                overlay.style.display = 'none';
                closeBtn.removeEventListener('click', closeHandler);
            };

            closeBtn.addEventListener('click', closeHandler);
        }

        // Event listeners
        document.getElementById('startChatHost').addEventListener('click', startChatHost);
        document.getElementById('stopChatHost').addEventListener('click', stopChatHost);
        document.getElementById('hostSendMessageBtn').addEventListener('click', () => sendMessage(true));
        document.getElementById('hostMessageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(true);
            }
        });

        document.getElementById('joinChatClient').addEventListener('click', joinChatClient);
        document.getElementById('leaveChatClient').addEventListener('click', leaveChatClient);
        document.getElementById('clientSendMessageBtn').addEventListener('click', () => sendMessage(false));
        document.getElementById('clientMessageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(false);
            }
        });
        
        // Sayfa yÃ¼klendiÄŸinde
        window.addEventListener('load', function() {
            switchMode('host'); // VarsayÄ±lan olarak host modunda baÅŸla
        });
        
        // Sayfa kapatÄ±lÄ±rken kaynaklarÄ± temizle
        window.addEventListener('beforeunload', function() {
            cleanup();
        });

        // TÃ¼m baÄŸlantÄ±larÄ± temizleyen yardÄ±mcÄ± fonksiyon (Peer kapatÄ±ldÄ±ÄŸÄ±nda veya mod deÄŸiÅŸtirildiÄŸinde)
        function cleanupConnections() {
            if (isHost) {
                for (let peerId in activeConnections) {
                    activeConnections[peerId].close();
                }
                activeConnections = {};
            } else { // Client
                if (hostConnection) {
                    hostConnection.close();
                    hostConnection = null;
                }
            }
        }
    </script>
</body>
</html>
